# Neuro Translate (MV3 Extension)

## Что делает расширение
Neuro Translate — это расширение для перевода веб‑страниц по запросу. Оно переводит текст блоками, может генерировать переводческий контекст и выполнять вычитку результата, сохраняя структуру, плейсхолдеры и пунктуационные токены.

## Архитектура
- **Контексты**: background service worker (источник истины), content script (страница), popup (UI), debug (диагностика).
- **Каналы связи**: `runtime.sendMessage` для одноразовых сообщений, `runtime.connect`/Port для долгоживущих каналов.
- **Source of truth**: состояние хранится в background (память + storage для восстановления), UI подписывается на `STATE_PATCH`/`STATE_SNAPSHOT`.

## Установка (загрузка распакованного расширения)
1. Откройте `chrome://extensions` (или `edge://extensions`).
2. Включите режим разработчика.
3. Нажмите **Load unpacked** и выберите папку `extension/`.

## Использование
- **Translate**: запускает перевод страницы.
- **Cancel**: останавливает перевод.
- **Toggle**: переключает показ оригинала/перевода.
- **Context**: опционально генерирует контекст перед переводом.
- **Proofread**: опционально выполняет вычитку перевода.
- **Notifications**: системные уведомления о прогрессе/ошибках (выключены по умолчанию, включаются через storage).

## Отладка
- Откройте `debug.html` для диагностики запросов и статусов.
- В `debug.html` доступны снимки состояния и сырые записи запросов/ответов.
- Хранилище debug‑данных: `translationDebugByUrl` (storage) + IndexedDB (`nt_debug`).

## Настройки моделей
- **manual** → выбирается самая «умная» модель из списка.
- **retry/validate** → выбирается самая дешёвая модель.
- Порядок и стратегия определяются списками моделей и политикой fallback.

## Edge: заметки по устойчивости
- В Edge возможны задержки `storage` и редкие потери портов — UI автоматически переподключается.
- `STATE_SNAPSHOT` отправляется при подключении UI для восстановления состояния.
- При проблемах обновите вкладку и убедитесь, что расширение имеет права на сайт.

## Безопасность
- API‑ключ хранится в `chrome.storage.local`.
- Удаление: очистите значение API‑ключа в popup или удалите данные расширения в настройках браузера.

## Tests
Запуск тестов (из папки `extension/`):
- `npm run test`
- `npm run check`
